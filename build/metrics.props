<!--
  Metrics configuration: centralizes all paths and tool settings for Roslyn/SARIF
  collection and report output. Adjust here to move artifacts or change the tool
  location; scripts and targets consume these properties.
-->
<Project>
  <!-- Determine repository root even when SolutionDir is not provided (e.g., dotnet test project) -->
  <PropertyGroup>
    <_MetricsRoot Condition="'$(SolutionDir)' != ''">$([System.String]::Copy('$(SolutionDir)').TrimEnd('\'))</_MetricsRoot>
    <_MetricsRoot Condition="'$(SolutionDir)' == ''">$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\'))</_MetricsRoot>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Root for all metrics artifacts -->
    <MetricsDir>$(_MetricsRoot)\Metrics</MetricsDir>
    <!-- Roslyn metrics output -->
    <RoslynOutputDir>$(MetricsDir)\Roslyn</RoslynOutputDir>
    <!-- SARIF output from compiler -->
    <SarifOutputDir>$(MetricsDir)\Sarif</SarifOutputDir>
    <!-- Roslyn metrics inputs/outputs -->
    <RoslynSolutionMetricsOutputFile>$(RoslynOutputDir)\SolutionMetrics.g.xml</RoslynSolutionMetricsOutputFile>
    <RoslynMetricsSolutionPath>$(_MetricsRoot)\MetricsReporter.sln</RoslynMetricsSolutionPath>
    <!-- Metrics.exe location -->
    <RoslynMetricsToolDir>$(MSBuildThisFileDirectory)..\Resources\metrics\win-arm64</RoslynMetricsToolDir>
    <RoslynMetricsToolExe>$(RoslynMetricsToolDir)\Metrics.exe</RoslynMetricsToolExe>
    <!-- Feature toggles -->
    <SarifMetricsEnabled Condition="'$(SarifMetricsEnabled)' == ''">false</SarifMetricsEnabled>
    <RoslynMetricsEnabled Condition="'$(RoslynMetricsEnabled)' == ''">true</RoslynMetricsEnabled>
    <!-- Anchor project to run GenerateSolutionMetrics once -->
    <MetricsTargetsAnchorProject Condition="'$(MetricsTargetsAnchorProject)' == ''">MetricsReporter</MetricsTargetsAnchorProject>
  </PropertyGroup>

  <!-- OpenCover coverage configuration -->
  <PropertyGroup>
    <!-- Output locations -->
    <OpenCoverOutputDir Condition="'$(OpenCoverOutputDir)' == ''">$(MetricsDir)\OpenCover</OpenCoverOutputDir>
    <OpenCoverHtmlOutputDir Condition="'$(OpenCoverHtmlOutputDir)' == ''">$(OpenCoverOutputDir)\Html</OpenCoverHtmlOutputDir>
    <!-- Feature flags -->
    <OpenCoverInstrumentationEnabled Condition="'$(OpenCoverInstrumentationEnabled)' == ''">false</OpenCoverInstrumentationEnabled>
    <OpenCoverCollectionEnabled Condition="'$(OpenCoverCollectionEnabled)' == ''">false</OpenCoverCollectionEnabled>
    <OpenCoverHtmlReportEnabled Condition="'$(OpenCoverHtmlReportEnabled)' == ''">false</OpenCoverHtmlReportEnabled>
    <OpenCoverVerbose Condition="'$(OpenCoverVerbose)' == ''">true</OpenCoverVerbose>
    <OpenCoverInstrumentedTargetFramework Condition="'$(OpenCoverInstrumentedTargetFramework)' == ''">net8.0</OpenCoverInstrumentedTargetFramework>
    <!-- Tool commands -->
    <OpenCoverToolCommand Condition="'$(OpenCoverToolCommand)' == ''">dotnet tool run altcover</OpenCoverToolCommand>
    <ReportGeneratorToolCommand Condition="'$(ReportGeneratorToolCommand)' == ''">dotnet tool run reportgenerator</ReportGeneratorToolCommand>
    <!-- Filters and formatting -->
    <!-- OpenCoverAttributeFilter:
         - Leave empty to keep all symbols in coverage and handle “noise” via SuppressMessage so HTML shows suppressed rows.
         - Set to System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverageAttribute only when you truly want OpenCover to drop symbols entirely. -->
    <OpenCoverAssemblyFilter Condition="'$(OpenCoverAssemblyFilter)' == ''">Spectre</OpenCoverAssemblyFilter>
    <OpenCoverTypeFilter Condition="'$(OpenCoverTypeFilter)' == ''"></OpenCoverTypeFilter>
    <OpenCoverMethodFilter Condition="'$(OpenCoverMethodFilter)' == ''"></OpenCoverMethodFilter>
    <OpenCoverAttributeFilter Condition="'$(OpenCoverAttributeFilter)' == ''"></OpenCoverAttributeFilter>
    <OpenCoverReportFormatEnabled Condition="'$(OpenCoverReportFormatEnabled)' == ''">true</OpenCoverReportFormatEnabled>
    <OpenCoverAdditionalInstrumentationArgs Condition="'$(OpenCoverAdditionalInstrumentationArgs)' == ''"></OpenCoverAdditionalInstrumentationArgs>
    <!-- Collection anchor (runs once after tests) -->
    <OpenCoverCollectorAnchorProject Condition="'$(OpenCoverCollectorAnchorProject)' == ''">MetricsReporter.Tests</OpenCoverCollectorAnchorProject>
  </PropertyGroup>

  <!-- Item group describing instrumented projects and their coverage outputs (explicit entries, no Identity usage) -->
  <ItemGroup>
    <OpenCoverProject Include="MetricsReporter">
      <ProjectName>MetricsReporter</ProjectName>
      <ProjectOutputDir>$(_MetricsRoot)\MetricsReporter\bin\$(Configuration)\$(OpenCoverInstrumentedTargetFramework)</ProjectOutputDir>
      <CoverageFile>$(OpenCoverOutputDir)\MetricsReporter.coverage.xml</CoverageFile>
      <TemplateCoverageFile>$(OpenCoverOutputDir)\MetricsReporter.coverage.template.xml</TemplateCoverageFile>
      <ProjectFile>$(_MetricsRoot)\MetricsReporter\MetricsReporter.csproj</ProjectFile>
    </OpenCoverProject>
    <OpenCoverProject Include="MetricsReporter.Tool">
      <ProjectName>MetricsReporter.Tool</ProjectName>
      <ProjectOutputDir>$(_MetricsRoot)\MetricsReporter.Tool\bin\$(Configuration)\$(OpenCoverInstrumentedTargetFramework)</ProjectOutputDir>
      <CoverageFile>$(OpenCoverOutputDir)\MetricsReporter.Tool.coverage.xml</CoverageFile>
      <TemplateCoverageFile>$(OpenCoverOutputDir)\MetricsReporter.Tool.coverage.template.xml</TemplateCoverageFile>
      <ProjectFile>$(_MetricsRoot)\MetricsReporter.Tool\MetricsReporter.Tool.csproj</ProjectFile>
    </OpenCoverProject>
  </ItemGroup>
</Project>

