<!--
  Metrics targets:
  - PrepareMetricsDirectories: creates SARIF output directory when SARIF metrics are enabled.
  - GenerateSolutionMetrics: runs Roslyn Metrics.exe once on the anchor project to produce SolutionMetrics.g.xml.
  - SetSarifErrorLog: configures compiler SARIF output when enabled.
-->
<Project>
  <!-- Computed OpenCover arguments -->
  <PropertyGroup>
    <OpenCoverFormatArg Condition="'$(OpenCoverReportFormatEnabled)' == 'true'"> --reportFormat=OpenCover</OpenCoverFormatArg>
    <OpenCoverAssemblyFilterArg Condition="'$(OpenCoverAssemblyFilter)' != ''"> --assemblyFilter="$(OpenCoverAssemblyFilter)"</OpenCoverAssemblyFilterArg>
    <OpenCoverTypeFilterArg Condition="'$(OpenCoverTypeFilter)' != ''"> --typeFilter="$(OpenCoverTypeFilter)"</OpenCoverTypeFilterArg>
    <OpenCoverMethodFilterArg Condition="'$(OpenCoverMethodFilter)' != ''"> --methodFilter="$(OpenCoverMethodFilter)"</OpenCoverMethodFilterArg>
    <OpenCoverAttributeFilterArg Condition="'$(OpenCoverAttributeFilter)' != ''"> --attributeFilter="$(OpenCoverAttributeFilter)"</OpenCoverAttributeFilterArg>
    <OpenCoverAdditionalArgs Condition="'$(OpenCoverAdditionalInstrumentationArgs)' != ''"> $(OpenCoverAdditionalInstrumentationArgs)</OpenCoverAdditionalArgs>
  </PropertyGroup>

  <!-- Ensure SARIF directory exists when SARIF logging is enabled -->
  <Target Name="PrepareMetricsDirectories"
          BeforeTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true'">
    <MakeDir Condition="'$(SarifMetricsEnabled)' == 'true' and '$(SarifOutputDir)' != ''"
             Directories="$(SarifOutputDir)" />
  </Target>

  <!-- Ensure OpenCover directories exist when instrumentation/collection/reporting is enabled -->
  <Target Name="PrepareOpenCoverDirectories"
          BeforeTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true' and ( '$(OpenCoverInstrumentationEnabled)' == 'true' or '$(OpenCoverCollectionEnabled)' == 'true' or '$(OpenCoverHtmlReportEnabled)' == 'true')">
    <MakeDir Directories="$(OpenCoverOutputDir)" />
    <MakeDir Condition="'$(OpenCoverHtmlReportEnabled)' == 'true'" Directories="$(OpenCoverHtmlOutputDir)" />
  </Target>

  <!-- Run Roslyn Metrics.exe once on the anchor project to produce SolutionMetrics.g.xml -->
  <Target Name="GenerateSolutionMetrics"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(RoslynMetricsEnabled)' == 'true' and '$(MSBuildProjectName)' == '$(MetricsTargetsAnchorProject)'">
    <MakeDir Directories="$(RoslynOutputDir)" />
    <MakeDir Condition="'$(SarifMetricsEnabled)' == 'true' and '$(SarifOutputDir)' != ''"
             Directories="$(SarifOutputDir)" />
    <Delete Files="$(RoslynSolutionMetricsOutputFile)" Condition="Exists('$(RoslynSolutionMetricsOutputFile)')" />
    <Exec Command="&quot;$(RoslynMetricsToolExe)&quot; /solution:&quot;$(RoslynMetricsSolutionPath)&quot; /out:&quot;$(RoslynSolutionMetricsOutputFile)&quot; /quiet"
          WorkingDirectory="$(RoslynMetricsToolDir)"
          IgnoreExitCode="false" />
  </Target>

  <!-- Configure compiler SARIF output when enabled -->
  <Target Name="SetSarifErrorLog"
          BeforeTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(SarifMetricsEnabled)' == 'true' and '$(SarifOutputDir)' != ''">
    <PropertyGroup>
      <ErrorLog>$(SarifOutputDir)\$(MSBuildProjectName).sarif,version=2.1</ErrorLog>
    </PropertyGroup>
  </Target>

  <!-- Instrument primary projects in-place with OpenCover -->
  <Target Name="InstrumentWithOpenCover"
          AfterTargets="Build"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(OpenCoverInstrumentationEnabled)' == 'true' and '@(OpenCoverProject->AnyHaveMetadataValue(''ProjectName'', ''$(MSBuildProjectName)''))' == 'true'">
    <ItemGroup>
      <_CurrentOpenCoverProject Include="@(OpenCoverProject)" Condition="'%(ProjectName)' == '$(MSBuildProjectName)'" />
    </ItemGroup>

    <PropertyGroup>
      <_OpenCoverInputDir>%(_CurrentOpenCoverProject.ProjectOutputDir)</_OpenCoverInputDir>
      <_OpenCoverSavedDir>$(_OpenCoverInputDir)\__Saved</_OpenCoverSavedDir>
      <_OpenCoverTemplateFile>%(_CurrentOpenCoverProject.TemplateCoverageFile)</_OpenCoverTemplateFile>
      <_OpenCoverReportFile>%(_CurrentOpenCoverProject.CoverageFile)</_OpenCoverReportFile>
    </PropertyGroup>

    <MakeDir Directories="$(OpenCoverOutputDir)" />
    <Delete Files="$(_OpenCoverTemplateFile)" Condition="Exists('$(_OpenCoverTemplateFile)')" />
    <RemoveDir Directories="$(_OpenCoverSavedDir)" Condition="Exists('$(_OpenCoverSavedDir)')" />
    <Message Text="Instrumenting $(_OpenCoverInputDir) with OpenCover; output $(_OpenCoverTemplateFile)." Importance="High" Condition="'$(OpenCoverVerbose)' == 'true'" />

    <Exec Command='$(OpenCoverToolCommand) --inputDirectory="$(_OpenCoverInputDir)" --inplace --save$(OpenCoverFormatArg) --report="$(_OpenCoverTemplateFile)"$(OpenCoverAssemblyFilterArg)$(OpenCoverTypeFilterArg)$(OpenCoverMethodFilterArg)$(OpenCoverAttributeFilterArg)$(OpenCoverAdditionalArgs)'
          ContinueOnError="false" />
  </Target>

  <!-- Collect coverage once after tests complete (anchored on test project) -->
  <Target Name="CollectOpenCoverCoverage"
          AfterTargets="Test;VSTest"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(OpenCoverCollectionEnabled)' == 'true' and '$(MSBuildProjectName)' == '$(OpenCoverCollectorAnchorProject)'">
    <PropertyGroup>
      <OpenCoverQuietFlags Condition="'$(OpenCoverVerbose)' != 'true'">-q</OpenCoverQuietFlags>
      <OpenCoverQuietFlags Condition="'$(OpenCoverVerbose)' == 'true'"></OpenCoverQuietFlags>
      <ReportGeneratorVerbosity Condition="'$(OpenCoverVerbose)' != 'true'">Error</ReportGeneratorVerbosity>
      <ReportGeneratorVerbosity Condition="'$(OpenCoverVerbose)' == 'true'">Info</ReportGeneratorVerbosity>
    </PropertyGroup>

    <ItemGroup>
      <_OpenCoverCollector Include="@(OpenCoverProject)">
        <RecorderDir>%(ProjectOutputDir)</RecorderDir>
        <CoverageFile>%(CoverageFile)</CoverageFile>
        <ProjectFile>%(ProjectFile)</ProjectFile>
        <ProjectName>%(ProjectName)</ProjectName>
      </_OpenCoverCollector>
    </ItemGroup>

    <Message Text="Collecting coverage from %(_OpenCoverCollector.RecorderDir) into %(_OpenCoverCollector.CoverageFile)." Importance="High" Condition="'$(OpenCoverVerbose)' == 'true'" />

    <!-- Ensure dependent projects are built (and instrumented) before collection -->
    <MSBuild Projects="%(_OpenCoverCollector.ProjectFile)"
             Targets="Build"
             Properties="OpenCoverInstrumentationEnabled=$(OpenCoverInstrumentationEnabled);OpenCoverCollectionEnabled=false;OpenCoverHtmlReportEnabled=false"
             Condition="Exists('%(_OpenCoverCollector.ProjectFile)')" />

    <Delete Files="%(_OpenCoverCollector.CoverageFile)" Condition="Exists('%(_OpenCoverCollector.CoverageFile)')" />

    <Exec Command='$(OpenCoverToolCommand) runner --collect --recorderDirectory="%(_OpenCoverCollector.RecorderDir)" --outputFile="%(_OpenCoverCollector.CoverageFile)" $(OpenCoverQuietFlags)'
          ContinueOnError="false"
          Condition="Exists('%(_OpenCoverCollector.RecorderDir)') and Exists('%(_OpenCoverCollector.RecorderDir)\altcover.recorder.g.dll')" />

    <ItemGroup>
      <_CollectedCoverage Include="%(_OpenCoverCollector.CoverageFile)" Condition="Exists('%(_OpenCoverCollector.CoverageFile)')" />
    </ItemGroup>

    <Error Text="OpenCover coverage files were not produced under $(OpenCoverOutputDir). Ensure instrumentation ran and tests executed against instrumented assemblies."
           Condition="'@(_CollectedCoverage)' == ''" />

    <MakeDir Directories="$(OpenCoverHtmlOutputDir)" Condition="'$(OpenCoverHtmlReportEnabled)' == 'true'" />
    <Exec Command="$(ReportGeneratorToolCommand) -reports:&quot;@(_CollectedCoverage->'%(FullPath)', ';')&quot; -targetdir:&quot;$(OpenCoverHtmlOutputDir)&quot; -reporttypes:Html -verbosity:$(ReportGeneratorVerbosity)"
          ContinueOnError="false"
          Condition="'$(OpenCoverHtmlReportEnabled)' == 'true' and '@(_CollectedCoverage)' != ''" />
  </Target>
</Project>

