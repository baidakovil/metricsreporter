<!--
  Metrics targets:
  - PrepareMetricsDirectories: creates SARIF output directory when SARIF metrics are enabled.
  - GenerateSolutionMetrics: runs Roslyn Metrics.exe once on the anchor project to produce SolutionMetrics.g.xml.
  - SetSarifErrorLog: configures compiler SARIF output when enabled.
-->
<Project>
  <!-- Ensure SARIF directory exists when SARIF logging is enabled -->
  <Target Name="PrepareMetricsDirectories"
          BeforeTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true'">
    <MakeDir Condition="'$(SarifMetricsEnabled)' == 'true' and '$(SarifOutputDir)' != ''"
             Directories="$(SarifOutputDir)" />
  </Target>

  <!-- Run Roslyn Metrics.exe once on the anchor project to produce SolutionMetrics.g.xml -->
  <Target Name="GenerateSolutionMetrics"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(RoslynMetricsEnabled)' == 'true' and '$(MSBuildProjectName)' == '$(MetricsTargetsAnchorProject)'">
    <MakeDir Directories="$(RoslynOutputDir)" />
    <MakeDir Condition="'$(SarifMetricsEnabled)' == 'true' and '$(SarifOutputDir)' != ''"
             Directories="$(SarifOutputDir)" />
    <Delete Files="$(RoslynSolutionMetricsOutputFile)" Condition="Exists('$(RoslynSolutionMetricsOutputFile)')" />
    <Exec Command="&quot;$(RoslynMetricsToolExe)&quot; /solution:&quot;$(RoslynMetricsSolutionPath)&quot; /out:&quot;$(RoslynSolutionMetricsOutputFile)&quot; /quiet"
          WorkingDirectory="$(RoslynMetricsToolDir)"
          IgnoreExitCode="false" />
  </Target>

  <!-- Configure compiler SARIF output when enabled -->
  <Target Name="SetSarifErrorLog"
          BeforeTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(SarifMetricsEnabled)' == 'true' and '$(SarifOutputDir)' != ''">
    <PropertyGroup>
      <ErrorLog>$(SarifOutputDir)\$(MSBuildProjectName).sarif,version=2.1</ErrorLog>
    </PropertyGroup>
  </Target>
</Project>

