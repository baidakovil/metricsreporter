## Reference: `.metricsreporter.json`, env vars, and precedence

This page summarizes the configuration model enforced by `metricsreporter` and the schema in `MetricsReporter/Configuration/metricsreporter-config.schema.json`. Use it to validate pipeline configs and to know which source wins when values differ.

### Precedence
1. **CLI options** – always win.
2. **Environment variables** – `METRICSREPORTER_*` keys.
3. **Config file** – `.metricsreporter.json` discovered by walking up from the working directory (unless `--config` overrides the path).
4. **Defaults** – `runScripts=true`, `aggregateAfterScripts=true`, `verbosity=normal`, `timeoutSeconds=900`, `logTruncationLimit=4000`, `workingDirectory=current directory`.

Validation happens before any command runs; failures return exit code `3`.

### Schema outline

| Section | Keys | Notes |
| --- | --- | --- |
| `general` | `runScripts`, `aggregateAfterScripts`, `verbosity`, `timeoutSeconds`, `workingDirectory`, `logTruncationLimit` | `runScripts` and `aggregateAfterScripts` default to `true`. `verbosity` accepts `quiet|minimal|normal|detailed`. `timeoutSeconds` and `logTruncationLimit` must be > 0. |
| `paths` | `metricsDir`, `solutionName`, `baselineReference`, `report` (generate output JSON), `readReport` (input JSON for read/readsarif/test), `thresholds`, `thresholdsInline`, arrays `altcover[]`, `roslyn[]`, `sarif[]`, `sourceCodeFolders[]`, plus `baseline`, `outputHtml`, `inputJson`, `coverageHtmlDir`, `baselineStoragePath`, `suppressedSymbols`, `solutionDirectory`, `excludedMembers`, `excludedAssemblies`, `excludedTypes`, `analyzeSuppressedSymbols` (bool), `replaceBaseline` (bool) | Paths are required when the corresponding command needs them; missing required paths cause validation errors. |
| `scripts` | `generate[]`, `read.any[]`, `read.byMetric[]`, `test.any[]`, `test.byMetric[]` | PowerShell script paths. `byMetric` items are `{ "metrics": ["RoslynClassCoupling", "AltCoverBranchCoverage"], "path": "tools/run-before-read.ps1" }`. `scripts.test` is used only by the `test` command. |

### Environment variable keys
- General: `METRICSREPORTER_RUN_SCRIPTS`, `METRICSREPORTER_AGGREGATE_AFTER_SCRIPTS`, `METRICSREPORTER_VERBOSITY`, `METRICSREPORTER_TIMEOUT_SECONDS`, `METRICSREPORTER_WORKING_DIRECTORY`, `METRICSREPORTER_LOG_TRUNCATION_LIMIT`.
- Paths: `METRICSREPORTER_PATHS_METRICS_DIR`, `..._SOLUTION_NAME`, `..._BASELINE_REF`, `..._REPORT`, `..._READ_REPORT`, `..._THRESHOLDS`, `..._THRESHOLDS_INLINE`, `..._ALTCOVER`, `..._ROSLYN`, `..._SARIF`, `..._BASELINE`, `..._OUTPUT_HTML`, `..._INPUT_JSON`, `..._COVERAGE_HTML_DIR`, `..._BASELINE_STORAGE_PATH`, `..._SUPPRESSED_SYMBOLS`, `..._SOLUTION_DIRECTORY`, `..._SOURCE_CODE_FOLDERS`, `..._EXCLUDED_MEMBERS`, `..._EXCLUDED_ASSEMBLIES`, `..._EXCLUDED_TYPES`, `..._ANALYZE_SUPPRESSED_SYMBOLS`, `..._REPLACE_BASELINE`.
- Scripts: `METRICSREPORTER_SCRIPTS_GENERATE`, `METRICSREPORTER_SCRIPTS_READ_ANY`, `METRICSREPORTER_SCRIPTS_READ_BYMETRIC`, `METRICSREPORTER_SCRIPTS_TEST_ANY`, `METRICSREPORTER_SCRIPTS_TEST_BYMETRIC` (semicolon-separated `metric1,metric2:path.ps1` entries).

### Validation rules (fail with exit code 3)
- Unknown root/section properties are rejected.
- Required sections (`general`, `paths`, `scripts`) must be present and be JSON objects.
- `scripts.read.byMetric` must contain objects with non-empty `metrics` array and non-empty `path` string; metrics must be strings.
- The same metric cannot appear in `scripts.read.byMetric` with different script paths (ambiguous configuration) — this is rejected.
- `scripts.test` follows the same validation rules as `scripts.read`.
- Malformed JSON or unreadable files produce a validation error before command execution.

### CLI ↔ config mapping (generate)

| CLI flag | Config path |
| --- | --- |
| `--run-scripts <true|false>` | `general.runScripts` |
| `--aggregate-after-scripts <true|false>` | `general.aggregateAfterScripts` |
| `--metrics-dir` | `paths.metricsDir` |
| `--solution-name` | `paths.solutionName` |
| `--altcover <path>` | appended to `paths.altcover[]` |
| `--roslyn <path>` | appended to `paths.roslyn[]` |
| `--sarif <path>` | appended to `paths.sarif[]` |
| `--baseline` | `paths.baseline` |
| `--baseline-ref` | `paths.baselineReference` |
| `--output-json` | `paths.report` |
| `--output-html` | `paths.outputHtml` |
| `--thresholds-file` | `paths.thresholds` |
| `--thresholds` (inline JSON) | `paths.thresholdsInline` |
| `--input-json` | `paths.inputJson` |
| `--coverage-html-dir` | `paths.coverageHtmlDir` |
| `--suppressed-symbols` | `paths.suppressedSymbols` |
| `--solution-dir` | `paths.solutionDirectory` |
| `--source-code-folders` | `paths.sourceCodeFolders[]` |
| `--replace-baseline` | `paths.replaceBaseline` |
| `--baseline-storage-path` | `paths.baselineStoragePath` |
| `--analyze-suppressed-symbols` | `paths.analyzeSuppressedSymbols` |

Readers (`read`, `readsarif`, `test`) use `paths.readReport` as the default report input. `read`/`readsarif` use `scripts.read.*`, while `test` uses `scripts.test.*`. Metric-scoped scripts run when any requested metric matches one of the configured identifiers.

### Scripts and process rules
- PowerShell is invoked as `pwsh -File <path>`.
- Scripts run sequentially; the pipeline stops on the first non-zero exit code.
- Timeout: from `general.timeoutSeconds` (default 900s) per script.
- Working directory: `general.workingDirectory` if set; otherwise the current directory.
- Stdout/stderr are captured; on failure they are logged with truncation cap `general.logTruncationLimit` (default 4000 chars).
- Aggregation defaults: `generate` always aggregates after scripts (even when `aggregateAfterScripts=false`). `read`/`readsarif`/`test` aggregate after scripts only when scripts run and at least one script is configured; warnings are emitted when aggregation is skipped.

### Sample config (paths from repo defaults)
```json
{
  "general": {
    "runScripts": true,
    "aggregateAfterScripts": true,
    "verbosity": "normal",
    "timeoutSeconds": 900,
    "logTruncationLimit": 4000
  },
  "paths": {
    "metricsDir": "Metrics",
    "report": "Metrics/MetricsReport.g.json",
    "readReport": "Metrics/MetricsReport.g.json",
    "baseline": "Metrics/MetricsTemp/MetricsBaseline.g.json",
    "thresholds": "Metrics/MetricsRules/MetricsReporterThresholds.json",
    "outputHtml": "Metrics/MetricsReport.html",
    "roslyn": [ "Metrics/Roslyn/SolutionMetrics.g.xml" ],
    "sarif": [ "Metrics/Sarif/*.sarif" ],
    "altcover": [ "Metrics/MetricsTemp/CoverageStorage.g.xml" ],
    "suppressedSymbols": "Metrics/MetricsTemp/SuppressedSymbols.g.json",
    "baselineStoragePath": "%LOCALAPPDATA%/RCA/Metrics",
    "solutionName": "metricsreporter"
  },
  "scripts": {
    "generate": [ "Metrics/scripts/prepare-metrics.ps1" ],
    "read": {
      "any": [ "scripts/refresh-report.ps1" ],
      "byMetric": [
        { "metrics": [ "AltCoverBranchCoverage", "AltCoverSequenceCoverage" ], "path": "scripts/coverage.ps1" },
        { "metrics": [ "SarifCaRuleViolations", "SarifIdeRuleViolations" ], "path": "scripts/readsarif.ps1" }
      ]
    },
    "test": {
      "any": [ "scripts/refresh-report.ps1" ]
    }
  }
}
```

