## Reference: `metricsreporter` CLI

The Spectre-based `metricsreporter` tool is the single entry point for generating reports and reading metrics. All commands share global options and the same precedence rules (CLI > env > config > defaults). No commands mutate source code; `generate` writes reports, `read`/`readsarif`/`test` only consume them.

### Global options

| Option | Description | Default |
| --- | --- | --- |
| `--config <PATH>` | Override `.metricsreporter.json` discovery (walk up from working directory when omitted). | Discovered file |
| `--verbosity <quiet|minimal|normal|detailed>` | Controls informational logging. | `normal` |
| `--timeout <SECONDS>` | Timeout per external script. | `900` |
| `--run-scripts <true|false>` | Enable/disable configured scripts. | `true` |
| `--aggregate-after-scripts <true|false>` | Aggregate metrics after scripts. Ignored by `generate` (aggregation always runs). | `true` |
| `--working-dir <PATH>` | Working directory for scripts and relative paths. | current directory |
| `--log-truncation-limit <INT>` | Max chars of stdout/stderr logged on script failure. | `4000` |

Exit codes (all commands): `0` success, `1` parse error, `2` IO error, `3` validation error.

### Command catalog

| Command | Purpose | Key inputs |
| --- | --- | --- |
| `generate` | Aggregates AltCover, Roslyn, SARIF, baseline into JSON/HTML. | `--metrics-dir`, `--altcover`, `--roslyn`, `--sarif`, `--baseline`, `--output-json`, `--output-html`, thresholds, filters, scripts. |
| `read` | Lists metric violations for any metric. | `--report`, `--namespace`, `--metric`, optional grouping and scripts. |
| `readsarif` | SARIF-focused breakdown grouped by rule id. | `--report`, `--namespace`, optional `--metric Any|SarifCaRuleViolations|SarifIdeRuleViolations`, `--ruleid`. |
| `test` | Checks a single symbol/metric pair. | `--report`, `--symbol`, `--metric`. |

### `generate`

```
metricsreporter generate --metrics-dir <PATH> --altcover <coverage.xml> --roslyn <metrics.xml> --sarif <rules.sarif> \
  --baseline <baseline.json> --output-json <report.json> [--output-html <report.html>] \
  [--thresholds-file <file> | --thresholds <json>] [--input-json <existing-report>] \
  [--coverage-html-dir <dir>] [--suppressed-symbols <file> --solution-dir <dir> --source-code-folders <list>] \
  [--replace-baseline] [--baseline-storage-path <dir>] [--script <ps1>...] [--run-scripts <true|false>] \
  [--excluded-members <list>] [--exclude-methods] [--exclude-properties] [--exclude-fields] [--exclude-events]
```

- Scripts: `--script` entries run before aggregation; fail-fast on non-zero exit. Uses `pwsh -File`, the configured working directory, and per-script timeout.
- Aggregation: always runs, even when `--aggregate-after-scripts=false` (flag is ignored for `generate` and a warning is emitted).
- Paths can come from config/env; missing required paths cause validation failure before execution.
- HTML-only mode: `--input-json` + `--output-html` skips parsing inputs and renders HTML from an existing report.

**Example (paths from repo defaults)**

```powershell
metricsreporter generate `
  --metrics-dir Metrics `
  --altcover Metrics/MetricsTemp/CoverageStorage.g.xml `
  --roslyn Metrics/Roslyn/SolutionMetrics.g.xml `
  --sarif Metrics/Sarif/ca.sarif `
  --baseline Metrics/MetricsTemp/MetricsBaseline.g.json `
  --output-json Metrics/MetricsReport.g.json `
  --output-html Metrics/MetricsReport.html `
  --thresholds-file Metrics/MetricsRules/MetricsReporterThresholds.json
```

### `read`

```
metricsreporter read --report <MetricsReport.g.json> --namespace <NamespacePrefix> --metric <MetricIdentifierOrAlias> \
  [--symbol-kind <Any|Type|Member>] [--all] [--group-by <metric|namespace|type|method>] [--ruleid <CAxxxx|IDExxxx>] \
  [--thresholds-file <PATH>] [--include-suppressed] [--script <ps1>...] [--metric-script <Metric=ps1>...] \
  [--run-scripts <true|false>] [--aggregate-after-scripts <true|false>]
```

- Scripts: executes `scripts.read.any` plus any `scripts.read.byMetric` entries that match the requested metric(s). CLI `--script` and `--metric-script` can override/augment config.
- Aggregation: after scripts succeed, a fresh report is generated by default using config/env paths and written to `--report`. Aggregation is skipped when `--run-scripts=false`, `--aggregate-after-scripts=false`, or when no scripts are configured; a warning is emitted when skipped.
- Output: first violation by default; `--all` returns all matches. Grouping reshapes output (see report schema).

### `readsarif`

```
metricsreporter readsarif --report <MetricsReport.g.json> --namespace <NamespacePrefix> \
  [--metric <Any|SarifCaRuleViolations|SarifIdeRuleViolations>] [--ruleid <CAxxxx|IDExxxx>] \
  [--symbol-kind <Any|Type|Member>] [--all] [--group-by <metric|namespace|type|method|ruleId>] \
  [--thresholds-file <PATH>] [--include-suppressed] [--script <ps1>...] [--metric-script <Metric=ps1>...] \
  [--run-scripts <true|false>] [--aggregate-after-scripts <true|false>]
```

- Defaults: `metric=Any`, `group-by=ruleId`.
- Metric-scoped scripts fire when requested metrics intersect configured `metrics` lists.
- Aggregation rules match `read`: reruns the pipeline after scripts by default, writes to `--report`, and is skipped (with a warning) when scripts are disabled or absent.

### `test`

```
metricsreporter test --report <MetricsReport.g.json> --symbol <FullyQualifiedName> --metric <MetricIdentifierOrAlias> \
  [--thresholds-file <PATH>] [--include-suppressed] [--script <ps1>...] [--metric-script <Metric=ps1>...] \
  [--run-scripts <true|false>] [--aggregate-after-scripts <true|false>]
```

Returns a compact JSON payload with status for the requested symbol/metric. The `test` command only honors `scripts.test.*`; aggregation follows the same rules as `read` (skipped if scripts are disabled or missing).

### Process and logging rules (all commands)
- PowerShell invoked as `pwsh -File <script>`.
- Sequential execution; first non-zero exit aborts the command.
- Timeout per script from `--timeout`/config; stdout/stderr captured and truncated to `--log-truncation-limit` on failure.
- Logging uses file output under the chosen working tree (`MetricsReporter.log` in report/output directories for generate; `MetricsReporter.read.log` near the input report for reader commands) and respects `--verbosity`.

