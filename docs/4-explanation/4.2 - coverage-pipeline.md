## Explanation: Coverage Pipeline

OpenCover XML files are the primary source for sequence, branch, cyclomatic, and NPath metrics. This document explains how Metrics Reporter ingests, normalizes, filters, and merges those files without corrupting other data sources.

### Data sources and identifiers

- OpenCover XML nodes map to `OpenCoverSequenceCoverage`, `OpenCoverBranchCoverage`, `OpenCoverCyclomaticComplexity`, and `OpenCoverNPathComplexity`.
- Metric identifiers live in `MetricIdentifier` and receive unit metadata via `MetricDescriptorCatalog` so the HTML dashboard can format percentages vs. raw counts.

### Parsing strategy

`OpenCoverMetricsParser` walks the XML hierarchy `CoverageSession → Modules → Module → Classes → Class → Methods → Method`.

| XML element | Code element created | Notes |
| --- | --- | --- |
| `Module` | Assembly node | FQN equals module name. |
| `Class` | Type node | Names normalized to dot notation; `Outer/Nested` is converted to `Outer+Nested` first. |
| `Method` | Member node | `SymbolNormalizer` converts C++ separators and inserts `(...)` placeholders. |

- File mappings leverage `FileRef uid` plus the module-level `Files` table; the resulting `source.path`/line info lands in the JSON report.
- Namespace inference is handled later (see nested type doc), so the OpenCover parser intentionally sets the assembly as `ParentFullyQualifiedName` for all classes.

### Extracting metric values

`PopulateMetrics` (assemblies/types) and `PopulateMethodMetrics` (methods) read OpenCover `Summary` attributes:

| Attribute | Metric | Guard |
| --- | --- | --- |
| `sequenceCoverage` | `OpenCoverSequenceCoverage` | Always emitted when present. |
| `branchCoverage` | `OpenCoverBranchCoverage` | Only when `numBranchPoints > 0`. |
| `maxCyclomaticComplexity` | `OpenCoverCyclomaticComplexity` | Emitted if the attribute exists. |
| `maxNPathComplexity` | `OpenCoverNPathComplexity` | Same as above. |

Methods treat empty `<BranchPoints />` as “no branches” and skip the metric entirely, preventing misleading `0%` entries.

### Normalization and filtering

1. **Symbol normalization** – `SymbolNormalizer` replaces `::` with `.`, strips return types, and folds parameters to `(...)`.
2. **Namespace inference** – When Roslyn omitted a namespace entry (e.g., OpenCover-only data), `NamespaceResolutionHelper.ExtractNamespaceFromTypeFqn` slices the normalized FQN to synthesize the namespace. `<global>` is used when no dot exists.
3. **Member filtering** – `MemberFilter` removes constructors, iterator helpers (`<Method>d__0.MoveNext`), lambda-generated names (`*b__*`), and other noise based on `ExcludedMemberNamesPatterns`. Filtering happens after metrics are read, so the report simply omits those nodes altogether.

### Aggregation rules

- `MetricsAggregationService` merges OpenCover nodes with Roslyn/SARIF nodes by FQN.
- Coverage metrics are never summed across nodes; the newest non-null value wins. This safeguards against duplicate method definitions across partial classes.
- Assemblies/namespaces/types created from OpenCover remain even if Roslyn has no counterpart—HTML still needs to show coverage-only data.

### Handling multiple OpenCover files

- The CLI accepts repeated `--opencover` arguments; MSBuild passes each XML path separately.
- Before merging, the parser ensures no symbol appears in more than one file. Duplicates throw a parsing error (`InvalidOperationException`) to prevent data races between parallel coverage runs.

### Interaction with nested types and iterators

- OpenCover emits nested classes as `Outer/Nested` with plus notation. `PlainNestedTypeCoverageReconciler` later transfers coverage from `Outer+<Method>d__0` iterator classes onto the real method node (`Outer.Method(...)`). See the dedicated explanation for details.

### Why branch coverage guards matter

- Some projects instrument libraries with zero branch points (e.g., auto-generated designer classes). Recording `OpenCoverBranchCoverage=0` for such methods would mislead threshold evaluation. Guarding on `numBranchPoints > 0` ensures only meaningful metrics enter the report.

### Troubleshooting tips

- **Missing coverage** – Verify `OpenCoverEnabled=true` and that your XML files sit in the configured `paths.opencover[]`. The parser logs a warning when no files are found.
- **Symbols stuck under `<global>`** – Usually indicates namespaces were stripped upstream. Add Roslyn metrics for the same assemblies or ensure namespaces exist in the parsed XML.
- **Branch coverage stuck at 0** – Check whether the methods actually have branch points. Iterator methods often require the iterator reconciliation step before they show real coverage.

