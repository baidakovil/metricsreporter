## Explanation: AI Agent Handbook

This note captures operational context for AI maintainers working on Metrics Reporter. Keep it close when automating refactors or debugging CI issues.

### Project structure

- `src/MetricsReporter` – Library that aggregates metrics and emits JSON/HTML.
- `src/MetricsReporter.Tool` – Pack-as-tool CLI exposing `metricsreporter` commands (Spectre.Console.Cli).
- `tests/MetricsReporter.Tests` – NUnit + FluentAssertions + NSubstitute.
- `docs/diataxis` – This documentation set (generated by you!).

### Distribution model

- Packages are published to a local feed: `C:\Users\baidakov\.nuget\local-feed`.
- Tool manifests in consumer repos (e.g., `sample-plugin/.config/dotnet-tools.json`) pin the exact `MetricsReporter.Tool` version.
- Tool binaries live in `%USERPROFILE%\.dotnet\tools` plus `%USERPROFILE%\.dotnet\toolspkgs`.
- Library packages can also be referenced directly via `PackageReference`.

### Working with versions

- Always bump at least the patch version after code changes. Reusing the same semantic version forces consumers to purge `%USERPROFILE%\.nuget\packages\metricsreporter*\<version>` and leads to confusing cache issues.
- After bumping, run `dotnet pack` for both the library and the tool, writing to the local feed.
- Update consumer repositories with `dotnet tool update --add-source <feed> MetricsReporter.Tool --version <new-version>` and, if needed, `dotnet add package MetricsReporter`.

### Running from source

- Use `dotnet run --project src/MetricsReporter.Tool/MetricsReporter.Tool.csproj -- <command>` when you need instant feedback without packing.
- For generator experiments, target `src/MetricsReporter/MetricsReporter.csproj` directly and pass explicit `--altcover`, `--roslyn`, `--sarif`, `--baseline`, `--output-json`, and `--output-html` flags.

### Metric generation workflow

```powershell
dotnet msbuild sample-plugin.sln /t:Build `
  /p:GenerateMetricsDashboard=true `
  /p:RoslynMetricsEnabled=true `
  /p:SarifMetricsEnabled=true `
  /p:MetricsTargetsAnchorProject=Sample.Core.Tests `
  /p:AltCoverEnabled=true `
  /p:MrCoverageEnabled=false
```

Outputs land in `build/Metrics/Report` (JSON/HTML) and `build/MetricsTemp` (baseline, suppressed symbols).

### Known warnings and caveats

- XML documentation is still incomplete in some public types (`CS1591`, `CS1734`, `CS1573`). Don’t suppress them; fix docs when touching those files.
- `Spectre.Console.Cli 1.0.0-alpha.0.7` triggers `NU5104` because it is pre-release. Either update Spectre to a stable build or mark Metrics Reporter as pre-release when packaging.
- AltCover is deeply integrated. If a consumer uses a different coverage generator, expect to update MSBuild targets, parser glue, and possibly schema definitions.

### Ideas for future cleanups

- Extract orchestration logic into a dedicated service (`IMetricsUpdateOrchestrator`) with structured results, so coverage generation or HTML updates can be composed without MSBuild glue.
- Improve logging by piping `ILogger` output into a persistent file (`MetricsReporter.log` already exists, but structured sinks could make analysis easier).
- Expand CI coverage by stubbing `IProcessRunner` to simulate AltCover, Roslyn, and SARIF inputs for integration tests.

Stay explicit about **why** you make changes—future AI agents rely on that context to keep the tool healthy.

