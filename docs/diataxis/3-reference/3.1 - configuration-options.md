## Reference: `.metricsreporter.json` and Option Precedence

Metrics Reporter can be configured through CLI flags, environment variables, or JSON files. This page summarizes the precedence model and the schema exposed in `src/MetricsReporter/Configuration/metricsreporter-config.schema.json`.

### Precedence rules

1. **CLI options** – anything passed to `MetricsReporter.exe` or `metricsreporter` overrides the rest.
2. **Environment variables** – `METRICSREPORTER_*` keys override config files.
3. **Config file** – `.metricsreporter.json` discovered by walking up from the working directory, unless `--config` specifies a different file.
4. **Defaults** – hard-coded fallbacks such as `verbosity=normal`, `timeoutSeconds=900`, `logTruncationLimit=4000`, `workingDirectory=current directory`.

### Schema overview

| Section | Key fields | Notes |
| --- | --- | --- |
| `general` | `verbosity`, `timeoutSeconds`, `workingDirectory`, `logTruncationLimit` | Mirrors CLI flags; `verbosity` accepts `quiet|minimal|normal|detailed`. |
| `paths` | `metricsDir`, `solutionName`, `baselineReference`, `report`, `readReport`, `thresholds`, `thresholdsInline`, arrays (`altcover[]`, `roslyn[]`, `sarif[]`, `sourceCodeFolders[]`) | Required for generator commands. Missing required paths trigger schema validation errors before execution. |
| `scripts` | `generate[]`, `read.any[]`, `read.byMetric[]` | Arrays of PowerShell paths. `read.byMetric` accepts objects `{ metrics: ["RoslynClassCoupling"], path: "scripts/warn.ps1" }`. Scripts run before the corresponding command executes. |

### Environment variable naming

- Start with `METRICSREPORTER_`.
- Replace nested sections with underscores: `METRICSREPORTER_PATHS_METRICS_DIR`, `METRICSREPORTER_PATHS_ALTcover` (repeatable entries separated by semicolons), `METRICSREPORTER_GENERAL_VERBOSITY`, etc.
- Script collections use `;`-separated entries: `METRICSREPORTER_SCRIPTS_READ_BYMETRIC=Coupling,Maintainability:tools\warn.ps1`.

### CLI to config mapping (generate command)

| CLI flag | Config path |
| --- | --- |
| `--metrics-dir` | `paths.metricsDir` |
| `--solution-name` | `paths.solutionName` |
| `--report` | `paths.report` |
| `--baseline` | `paths.baseline` |
| `--altcover <path>` | appended to `paths.altcover[]` |
| `--roslyn <path>` | appended to `paths.roslyn[]` |
| `--sarif <path>` | appended to `paths.sarif[]` |
| `--thresholds-file` | `paths.thresholds` |
| `--thresholds` (inline JSON) | `paths.thresholdsInline` |

Readers (`readany`, `readsarif`, `test`) reuse `paths.readReport` and script hooks under `scripts.read.any`/`scripts.read.byMetric`.

### Validation

- The schema enforces data types and nullability; violations produce `validation error (exit code 3)` with pointers to the failing JSON path.
- Custom validators ensure arrays such as `altcover[]` or `roslyn[]` are not empty when required by the command.

### Script hooks

| Hook | Trigger | Typical use |
| --- | --- | --- |
| `scripts.generate[]` | Before aggregating metrics | Run custom PowerShell to download coverage artifacts or patch configs. |
| `scripts.read.any[]` | Before any reader command | Refresh dashboards or clean caches. |
| `scripts.read.byMetric[]` | Before reader commands requesting matching metrics | E.g., run a linter when `Coupling` or `Maintainability` queries are executed. |

Scripts inherit the working directory specified in `general.workingDirectory` (if set), otherwise the current directory of the CLI.

### Tips

- Keep `.metricsreporter.json` in the repository root so discovery “walk up” finds it immediately.
- Prefer config files for long arrays (AltCover paths, SARIF files) and CLI flags for ad-hoc overrides.
- For CI, export environment variables in the pipeline definition—no need to commit environment-specific paths.

