## Reference: `metrics-reader` CLI

`metrics-reader` is a Spectre.Console.Cli command set embedded into `MetricsReporter.Tool`. It never mutates the report—every command consumes an existing `MetricsReport.g.json`. When invoked without `--no-update`, the CLI first triggers the MSBuild targets `GenerateMetricsDashboard` and (if enabled) `CollectCoverage` to refresh artifacts before reading them.

### Command surface

| Command | Description |
| --- | --- |
| `metrics-reader readany` | Lists problematic symbols for any metric (AltCover, Roslyn metrics, SARIF counts). Supports grouping. |
| `metrics-reader readsarif` | Specialized view that keeps SARIF rule metadata and groups by `ruleId`. |
| `metrics-reader test` | Validates a single symbol/metric pair to quickly check threshold status. |

### Shared options

| Option | Default | Notes |
| --- | --- | --- |
| `--report <PATH>` | `build/Metrics/Report/MetricsReport.g.json` | Source JSON. Required when running outside the MSBuild pipeline. |
| `--thresholds-file <PATH>` | Thresholds embedded in report metadata | Temporarily overrides `ReportMetadata.thresholdsByLevel`. |
| `--include-suppressed` | `false` | When `true`, symbols flagged via `[SuppressMessage]` are kept in the output. Otherwise they are filtered out. |
| `--no-update` | `false` | Skips MSBuild targets and uses the current report as-is. Essential for CI steps that have already generated metrics. |
| `--group-by <metric|namespace|type|member|ruleId>` | `None` (`readany`), `ruleId` (`readsarif`) | Switches JSON shape to grouped payloads (see below). |
| `--verbosity <quiet|minimal|normal|detailed>` | `normal` | Pass-through to the shared logging pipeline. |

The Spectre registrar (`MetricsReaderCommandConfigurator`) wires these options into each command via reusable settings classes (`CommonReportSettings`, `NamespaceMetricSettings`, `SarifMetricSettings`, etc.).

### Grouped payload structure

When `--group-by` is specified, both `readany` and `readsarif` return an envelope:

```json
{
  "metric": "RoslynClassCoupling",
  "namespace": "Sample.Loader.Services",
  "symbolKind": "Any",
  "includeSuppressed": false,
  "groupBy": "type",
  "violationsGroupsCount": 12,
  "violationsGroups": [
    {
      "key": "Sample.Loader.Services.CommandValidationService",
      "violationsCount": 4,
      "violations": [
        {
          "symbolFqn": "Sample.Loader.Services.CommandValidationService.ValidateAsync(...)",
          "value": 78,
          "threshold": 70,
          "delta": 5,
          "status": "Error",
          "filePath": "src/Sample.Loader/Services/CommandValidationService.cs",
          "isSuppressed": false
        }
      ]
    }
  ]
}
```

Without `--group-by`, the command either emits the first violation (default) or the entire list when `--all` is set.

### `readany`

```
metrics-reader readany --namespace <NamespacePrefix> --metric <MetricIdentifierOrAlias>
                       [--symbol-kind <Any|Type|Member>] [--all] [--group-by ...]
                       [shared options]
```

- Metric aliases include `Complexity`, `Maintainability`, `Coupling`, `Coverage`, `Inheritance`, etc. `MetricIdentifierResolver` maps them to canonical keys.
- `SymbolQueryService` builds a `SymbolFilter` from namespace, symbol kind, and suppression settings.
- `SymbolSnapshotOrderer` sorts matches: types before members, status severity (Error > Warning > Success), then magnitude of threshold violation, then FQN.
- `ReadAnyCommandResultHandler` chooses between flat or grouped output.

**Example**

```powershell
metrics-reader readany --namespace Sample.Loader.Services `
  --metric Complexity `
  --group-by type `
  --all
```

### `readsarif`

```
metrics-reader readsarif --namespace <NamespacePrefix>
                         [--metric <SarifCaRuleViolations|SarifIdeRuleViolations|Any>]
                         [--ruleid <CAxxxx|IDExxxx>]
                         [--symbol-kind <Any|Type|Member>]
                         [--all] [--group-by ...]
                         [shared options]
```

- Defaults to `groupBy ruleId`. `SarifMetricSettings` validates the metric choice.
- `SarifGroupAggregator` walks `MetricValue.Breakdown` to build `SarifViolationGroupBuilder` items enriched with `SarifSymbolContribution`.
- `SarifGroupSorter` orders by `violationsCount DESC`, then `ruleId`.
- `SarifGroupFilter` applies the `--ruleid` filter after sorting.
- Result items include `ruleId`, `shortDescription`, `violationsCount`, and each violation’s symbol, message, URI, and line range.

**Example**

```powershell
metrics-reader readsarif --namespace Sample.Loader `
  --metric SarifCaRuleViolations `
  --ruleid CA1506 `
  --group-by ruleId
```

### `test`

```
metrics-reader test --symbol <FullyQualifiedName>
                    --metric <MetricIdentifierOrAlias>
                    [shared options]
```

- Evaluates a single symbol/metric pair against thresholds.
- Returns a short payload containing the resolved metric value, the active thresholds, and any delta relative to baseline.
- Helpful for scripting “gate” checks (e.g., fail if `RoslynMaintainabilityIndex` drops below 50 for a specific type).

### Suppression handling

- Suppressed symbols are tracked in `SuppressedSymbols.g.json`, cross-linked through `SuppressedSymbolsService`.
- The CLI excludes them unless `--include-suppressed` is passed, ensuring dashboard statistics and CLI calls stay aligned.

### Error handling and exit codes

| Scenario | Exit code | Notes |
| --- | --- | --- |
| Parsing or validation failure | `1` | Invalid namespace, metric alias, or missing report file. |
| IO failure | `2` | Report file cannot be opened. |
| Execution success | `0` | JSON payload written to stdout. |

Errors are logged through `ILogger` (Spectre’s default console theme) and include actionable hints (e.g., which metric alias failed to resolve).

